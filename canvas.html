<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sticky Notes Canvas</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Add directly here or keep in styles.css */
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    #selectFolderBtn, #addNoteBtn {
      padding: 10px 20px;
      background: #4a6bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    #selectFolderBtn:hover, #addNoteBtn:hover {
      background: #3a5bef;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="selectFolderBtn">Select Folder</button>
    <button id="addNoteBtn" disabled>Add Note</button>
  </div>
  <div id="canvas"></div>
  <script>
    const canvas = document.getElementById('canvas');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const selectFolderBtn = document.getElementById('selectFolderBtn');

    let dragNote = null, offsetX = 0, offsetY = 0;
    let directoryHandle = null;

    function formatDate(date) {
      return date.toLocaleString();
    }

    function createNote(x, y, text = "New note", existingFileHandle = null) {
      let noteFileHandle = existingFileHandle;

      const note = document.createElement('div');
      note.className = 'note';
      note.style.left = x + 'px';
      note.style.top = y + 'px';

      const colorPicker = document.createElement('div');
      colorPicker.className = 'color-picker';
      colorPicker.style.background = '#fff8a6';

      const colorOptions = document.createElement('div');
      colorOptions.className = 'color-options';

      const colors = [
        { name: 'default', value: '#fff8a6' },
        { name: 'green', value: '#d4edda' },
        { name: 'pink', value: '#f8d7da' },
        { name: 'orange', value: '#ffe8cc' },
        { name: 'purple', value: '#e2d4f0' },
        { name: 'brown', value: '#efd9c1' }
      ];

      colors.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.className = 'color-option';
        colorOption.style.background = color.value;
        colorOption.addEventListener('click', (e) => {
          e.stopPropagation();
          note.className = 'note';
          if (color.name !== 'default') {
            note.classList.add(color.name);
          }
          colorPicker.style.background = color.value;
          colorPicker.classList.remove('expanded');
        });
        colorOptions.appendChild(colorOption);
      });

      colorPicker.appendChild(colorOptions);
      colorPicker.addEventListener('click', (e) => {
        e.stopPropagation();
        colorPicker.classList.toggle('expanded');
      });

      let logs = [];
      let isEditing = false;
      let isSaved = !!existingFileHandle;
      let currentLogIndex = null;

      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.setAttribute('spellcheck', 'false');
      textarea.setAttribute('readonly', 'readonly');
      textarea.style.background = '#f9f9f9';

      function autoResizeTextarea() {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }
      autoResizeTextarea();
      textarea.addEventListener('input', autoResizeTextarea);

      const btnContainer = document.createElement('div');
      btnContainer.className = 'btn-container';

      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.onclick = function () {
        if (!isEditing) {
          textarea.removeAttribute('readonly');
          textarea.style.background = 'transparent';
          textarea.focus();
          isEditing = true;
          showButtons();
        } else {
          if (currentLogIndex !== null && logs.length > 0) {
            logs[currentLogIndex].text = textarea.value;
            logs[currentLogIndex].updated = new Date();
            isEditing = false;
            textarea.setAttribute('readonly', 'readonly');
            textarea.style.background = '#f9f9f9';
            showButtons();
          }
        }
      };

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.style.display = 'none';
      saveBtn.onclick = async function () {
        textarea.setAttribute('readonly', 'readonly');
        textarea.style.background = '#f9f9f9';
        isEditing = false;
        isSaved = true;

        const now = new Date();
        logs.push({ text: textarea.value, saved: now, updated: now });
        currentLogIndex = logs.length - 1;
        showButtons();

        try {
          if (!directoryHandle && !(await selectFolder())) {
            const blob = new Blob([textarea.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `note-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            return;
          }

          if (!noteFileHandle) {
            const fileName = `note-${Date.now()}.txt`;
            noteFileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
          }

          const writable = await noteFileHandle.createWritable();
          await writable.write(textarea.value);
          await writable.close();
          alert('Note saved.');
        } catch (error) {
          console.error('Error saving file:', error);
          alert('Failed to save note.');
        }
      };

      textarea.addEventListener('input', function () {
        if (isEditing) {
          saveBtn.style.display = '';
        }
      });

      const logDropdown = document.createElement('select');
      logDropdown.className = 'log-dropdown';

      const logBtn = document.createElement('button');
      logBtn.textContent = 'Log';
      logBtn.onclick = function (e) {
        e.stopPropagation();
        if (logs.length === 0) {
          alert('No logs yet.');
          return;
        }
        logDropdown.innerHTML = '';
        logs.forEach((log, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = `#${idx + 1} - ${formatDate(log.saved)}`;
          logDropdown.appendChild(option);
        });
        logDropdown.style.display = logDropdown.style.display === 'none' ? 'block' : 'none';
        if (logDropdown.style.display === 'block') {
          logDropdown.focus();
        }
      };

      logDropdown.addEventListener('mousedown', (e) => e.stopPropagation());
      logDropdown.onchange = function () {
        const idx = parseInt(logDropdown.value, 10);
        if (!isNaN(idx) && logs[idx]) {
          textarea.value = logs[idx].text;
          autoResizeTextarea();
          currentLogIndex = idx;
        }
        logDropdown.style.display = 'none';
      };

      btnContainer.appendChild(editBtn);
      btnContainer.appendChild(saveBtn);
      btnContainer.appendChild(logBtn);
      btnContainer.appendChild(logDropdown);

      note.appendChild(colorPicker);
      note.appendChild(btnContainer);
      note.appendChild(textarea);
      canvas.appendChild(note);

      function showButtons() {
        editBtn.style.display = '';
        saveBtn.style.display = isEditing ? '' : 'none';
        logBtn.style.display = '';
      }

      note.addEventListener('mousedown', function (ev) {
        if (['TEXTAREA', 'BUTTON', 'SELECT'].includes(ev.target.tagName)) return;
        dragNote = note;
        offsetX = ev.offsetX;
        offsetY = ev.offsetY;
        note.style.zIndex = 10;
      });

      note.addEventListener('click', function () {
        note.style.zIndex = 10;
        Array.from(canvas.children).forEach(child => {
          if (child !== note) child.style.zIndex = 1;
        });
      });

      showButtons();
    }

    addNoteBtn.addEventListener('click', function () {
      createNote(60 + Math.random() * 300, 60 + Math.random() * 200);
    });

    canvas.addEventListener('dblclick', function (e) {
      if (e.target !== canvas) return;
      createNote(e.clientX - canvas.getBoundingClientRect().left,
                 e.clientY - canvas.getBoundingClientRect().top);
    });

    document.addEventListener('mousemove', function (e) {
      if (!dragNote) return;
      dragNote.style.transform = `translate(${e.clientX - offsetX - dragNote.getBoundingClientRect().left}px, 
                                            ${e.clientY - offsetY - dragNote.getBoundingClientRect().top}px)`;
    });

    document.addEventListener('mouseup', function () {
      if (dragNote) {
        const rect = dragNote.getBoundingClientRect();
        dragNote.style.left = rect.left + 'px';
        dragNote.style.top = rect.top + 'px';
        dragNote.style.transform = 'none';
        dragNote.style.zIndex = 1;
        dragNote = null;
      }
    });

    async function selectFolder() {
      try {
        if (!window.showDirectoryPicker) {
          throw new Error('File System Access API not supported');
        }

        directoryHandle = await window.showDirectoryPicker();
        addNoteBtn.disabled = false;
        await loadExistingNotes();
        return true;
      } catch (error) {
        console.error('Folder selection error:', error);
        alert('Could not access folder. Notes will be downloaded instead.');
        return false;
      }
    }

    async function loadExistingNotes() {
      for await (const [name, handle] of directoryHandle.entries()) {
        if (handle.kind === 'file' && name.endsWith('.txt')) {
          const file = await handle.getFile();
          const text = await file.text();
          createNote(60 + Math.random() * 300, 60 + Math.random() * 200, text, handle);
        }
      }
    }

    selectFolderBtn.addEventListener('click', selectFolder);
  </script>
</body>
</html>
